---
title: "Comparison across studies"
author: "Katie Thomas"
date: 01 Nov 2021
output:
  html_document:
    code_fold: hide
    theme: flatly
    toc: yes
    toc_float: yes
---

<style type="text/css">

body{ /* Normal  */
      font-size: 17px;
  }
  
</style>

```{r setup, include = FALSE}

#global rmarkdown options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

#load packages
library(knitr)
library(kableExtra)
library(gridExtra)
library(grid)
library(gtable)
library(cowplot)
library(plyr)
library(tidyverse)
library(AmphiNom)
```

# Load datasets

Here, we import our tidied adult pupil data along with data from two other published papers that categorized adult pupil shape. 

## This study

```{r}
#import cleaned data
thomas.data <- data.frame(read.csv("../Cleaned data/pupil_data_refs.csv", header=TRUE, na.strings=c("NA"))) %>%
  rename(pupil_ref_Thomas = Source) %>%
  rename(pupil_link_Thomas = Pupil_link) %>%
  rename(pupil_link2_Thomas = Pupil_link_2) %>%
  rename(ecology_ref_Thomas = references) %>%
  select(!c(AH_source,AP_source,Tadpole_shape,Tadpole_source,Tad_pupil_link,Tad_pupil_link2,eye_av))

#subset data with ecology 
thomas.data.eco <- thomas.data %>% 
   filter(!if_all(c(aquatic, arboreal, fossorial, diurnal), is.na))
```

- Number of species sampled: `r length(levels(as.factor(thomas.data$genus_species)))`
- Number of genera sampled: `r length(levels(as.factor(thomas.data$Genus)))`
- Number of families sampled: `r length(levels(as.factor(thomas.data$Family)))`

- Species with ecological data: `r length(levels(as.factor(thomas.data.eco$genus_species)))`
- Genera with ecological data: `r length(levels(as.factor(thomas.data.eco$Genus)))`
- Families with ecological data: `r length(levels(as.factor(thomas.data.eco$Family)))`


## Yovanovich et al. 2020

These data for post-metamorphic pupil shape are from the following study:

> Yovanovich CAM, Pierotti MER, Kelber A, Jorgewich-Cohen G, Ibáñez R,Grant T. 2020 Lens transmittance shapes ultraviolet sensitivity in the eyes of frogs from diverse ecological and phylogenetic backgrounds. Proc. R. Soc. B 287: 20192253. http://dx.doi.org/10.1098/rspb.2019.2253

Species data for pupil shape (categorized as elongated or circular) and activity period (categorized as nocturnal or diurnal) were transcribed into a csv file from Figure 1 in the paper.

Note that for pupil categorization, references are not listed. Methods just say they "visually inspected each of the species available on line and scored each of them on a dichotomic scale".

```{r}
#import transcribed data
yovanovich.data <- data.frame(read.csv("../Cleaned data/other studies/Yovanovich_et_al_2020.csv", header=TRUE, na.strings=c("NA"))) %>%
  mutate(Genus = gsub('_.*', '', Species)) %>%
  mutate(Order = "Anura") %>%
  mutate(genus_species = Species) %>%
  select(genus_species, Order, Family, Genus, pupil_shape, act_period)
```

- Number of species sampled: `r length(levels(as.factor(yovanovich.data$genus_species)))`
- Number of genera sampled: `r length(levels(as.factor(yovanovich.data$Genus)))`
- Number of families sampled: `r length(levels(as.factor(yovanovich.data$Family)))`

- Species with ecological data: `r length(levels(as.factor(yovanovich.data$genus_species)))`
- Genera with ecological data: `r length(levels(as.factor(yovanovich.data$Genus)))`
- Families with ecological data: `r length(levels(as.factor(yovanovich.data$Family)))`


## Cervinho et al. 2021

These data for adult pupil shape are from the following study:

> Cervino NG, Elias-Costa AJ, Pereyra MO, Faivovich J. 2021 A closer look at pupil diversity and evolution in frogs and toads. Proc. R. Soc. B 288: 20211402. https://doi.org/10.1098/rspb.2021.1402

There are two data files, each transcribed from a different supplemental table. 

1) A file showing pupil shape across all species sampled in the study (Anura + Caudata). Pupil shape was categorized into seven states: vertical, horizontal, rhomboidal/subrhomboidal, circular, triangular, fan, inverted fan. This is transcribed from Appendix S2 of the paper. 

2) A file showing pupil shape (same categories), adult habit (aquatic, semi-aquatic, ground-dwelling, fossorial, scansorial), and adult activity period (diurnal, arrythmic, nocturnal) for a subset of the species from the full dataset. This is transcribed from Table 1 in Appendix S4 of the paper. 

We import both and then merge them into a single dataframe. 

**Note:** For some reason there are duplicates of some of the species in Supplement 2 table from this paper. Species are listed twice, often with different lists of references used for pupil coding.

Duplicate taxa listed in table S2:

- _Abavorana luctuosa_ (two rows with different references cited)
- _Amolops ricketti_ (two rows with different references cited)
- _Chalcorana chalconota_ (two rows with different references cited)
- _Feihyla kajau_ (two rows with different references cited)
- _Heleophryne rosei_ (two rows with different references cited)
- _Leptomantis gauni_ (two rows with different references cited)
- _Micrixalus_saxicola_ (two rows with different references cited)
- _Pulchrana glandulosa_ (two rows with different references cited)
- _Pulchrana signata_ (two rows with different references cited)
- _Scutiger tuberculatus_ (two identical rows with same reference cited)

In all cases, the pupil categorization for the duplicate taxa is the same. Thus, we remove duplicates from the dataset before using it. 


```{r}

#import pupil shape data
cervino.data.shape <- data.frame(read.csv("../Cleaned data/other studies/Cervino_et_al_2021_pupils.csv", header=TRUE, na.strings=c("NA"))) %>%
  mutate(genus_species = gsub(' ', '_', Species)) %>%
  mutate(Genus = gsub(' .*', '', Species)) %>%
  rename(pupil_ref_Cervino = Reference_pupil) %>%
  select(genus_species, Order, Family, Genus, Pupil_shape, pupil_ref_Cervino)

#look at species with duplicate entries
n_occur <- data.frame(table(cervino.data.shape$genus_species))

#remove duplicate species
cervino.data.shape <- filter(cervino.data.shape,!duplicated(genus_species))

#import ecology data
cervino.data.eco <- data.frame(read.csv("../Cleaned data/other studies/Cervino_et_al_2021_ecology.csv", header=TRUE, na.strings=c("NA"))) %>%
  mutate(genus_species = gsub(' ', '_', Species)) %>%
  mutate(Genus = gsub(' .*', '', Species)) %>%
  rename(eco_ref_Cervino = Reference_ecology)

#check for species with duplicate entries
n_occur <- data.frame(table(cervino.data.eco$genus_species))

#merge these datasets
cervino.data <- left_join(cervino.data.shape, select(cervino.data.eco, genus_species, Adult_habits, Diel_activity, eco_ref_Cervino), by = "genus_species") 

#check for species with duplicate entries
n_occur <- data.frame(table(cervino.data$genus_species))
```

- Number of species sampled: `r length(levels(as.factor(cervino.data$genus_species)))`
- Number of genera sampled: `r length(levels(as.factor(cervino.data$Genus)))`
- Number of families sampled: `r length(levels(as.factor(cervino.data$Family)))`

- Species with ecological data: `r length(levels(as.factor(cervino.data.eco$genus_species)))`
- Genera with ecological data: `r length(levels(as.factor(cervino.data.eco$Genus)))`
- Families with ecological data: `r length(levels(as.factor(cervino.data.eco$Family)))`


# Match species across datasets using AmphiNom

Here, we deal with potential synonyms across datasets using the AmphiNom package. To match species up, we use the AmphiNom package by Liedtke (2019) to convert known synonyms to the taxonomy represented in Amphibian Speicies of the World (ASW). This addresses the bulk of missing taxa; the remaining need to be examined manually.

## Yovanovich et al. data

```{r}

#Screen names in dataset to see how well they match up to ASW and what can be 'updated' seamlessly
datanames.yov <- aswSync(yovanovich.data$genus_species)
synonymReport(datanames.yov)

#pull out all direct matches or updated ASW taxonomy
yov.update <- datanames.yov %>%
  filter(status == "up_to_date" | status =="updated") %>%
  mutate(genus_species = query) %>%
  select(genus_species, ASW_names)

#merge these updated names with original data update
yovanovich.ASW <- full_join(yovanovich.data, yov.update)

# check for duplicates of ASW species
n_occur <- data.frame(table(yovanovich.ASW$ASW_names))
```


## Cervino et al. data

```{r}
#Screen names in dataset to see how well they match up to ASW and what can be 'updated' seamlessly
datanames.cervino <- aswSync(cervino.data$genus_species)
synonymReport(datanames.cervino)

#pull out all direct matches or updated ASW taxonomy
cervino.update <- datanames.cervino %>%
  filter(status == "up_to_date" | status =="updated") %>%
  mutate(genus_species = query) %>%
  select(genus_species, ASW_names)

#add column to pupil data with updated ASW names
cervino_names <- left_join(cervino.data, cervino.update, by = "genus_species")

#check how many species aren't being matched to ASW names
missingASW <- cervino_names %>%
  filter(is.na(ASW_names)) %>%
  select(genus_species, ASW_names)

#add manual synonyms
filledASW <- missingASW %>%
  mutate(ASW_names = recode_factor(genus_species, 
                                   "Arthroleptis_taeniatus" = "Arthroleptis_taeniatus",
                                   "Sclerophrys_garmani" = "Sclerophrys_garmani",
                                   "Bufo_spinosus" = "Bufo_spinosus",
                                   "Bufotes_variabilis"="Bufotes_sitibundus", #no match, chose one of mult synonyms
                                   "Rhinella_pombali"="Rhinella_crucifer", #no match, chose one of mult synonyms
                                   "Cornufer_guentheri"="Cornufer_guentheri",
                                   "Cornufer_guppyi"="Cornufer_guppyi",
                                   "Craugastor_podiciferus"="Craugastor_podiciferus",
                                   "Microkayla_iatamasi" = "Microkayla_iatamasi",
                                   "Pristimantis_lynchi" = "Pristimantis_lynchi",
                                   "Eleutherodactylus_intermedius" = "Eleutherodactylus_intermedius",
                                   "Gastrotheca_fulvorufa" = "Gastrotheca_fulvorufa",
                                   "Nyctimystes_dux" = "Nyctimystes_dux",
                                   "Nyctimystes_montana" = "Nyctimystes_montanus",
                                   "Hyperolius_marmoratus" = "Hyperolius_marmoratus",
                                   "Pleurodema_bibroni" = "Pleurodema_bibroni",
                                   "Mantidactylus_mocquardi" = "Mantidactylus_mocquardi",
                                   "Micrixalus_herrei" = "Micrixalus_herrei",
                                   "Chaperina_fusca" = "Chaperina_fusca",
                                   "Chiasmocleis_albopunctata" = "Chiasmocleis_albopunctata",
                                   "Chiasmocleis_carvalhoi" = "Chiasmocleis_carvalhoi",
                                   "Phrynobatrachus_liberiensis" = "Phrynobatrachus_liberiensis",
                                   "Ptychadena_mascareniensis" = "Ptychadena_mascareniensis",
                                   "Papurana_daemeli" = "Papurana_daemeli",
                                   "Pelophylax_esculentus" = "Pelophylax_lessonae", #no match, chose one of mult synonyms
                                   "Leptomantis_fasciatus" = "Leptomantis_fasciatus",
                                   "Sclerophrys_rangeri" = "Sclerophrys_rangeri", #no ASW synonym, keeping original name
                                   "Centrolene_altitudinale" = "Centrolene_altitudinale", #no ASW synonym, keeping original name
                                   "Liurana_alpine" = "Liurana_alpina", 
                                   "Bahius_bilineatus" = "Bahius_bilineatus",
                                   "Cycloramphus_Eleuthero" = "Cycloramphus_Eleuthero", #this appears to be a typo in the dataset, species does not exist and capitalization suggests it's a genus name typo
                                   "Boana_rufitelus" = "Boana_rufitela",
                                   "Nyctimantis_brunoi" = "Nyctimantis_brunoi",
                                   "Nyctimantis_pomba" = "Nyctimantis_pomba",
                                   "Nyctimantis_siemersi" = "Nyctimantis_siemersi",
                                   "Trachycephalus_venulosus" = "Trachycephalus_typhonius", #not exact synonym on ASW but my best guess
                                   "Nyctimystes_lubisi" = "Nyctimystes_lubisi",
                                   "Nyctimystes_multicolor" = "Nyctimystes_multicolor",
                                   "Nyctomystes_pterodactyla" = "Nyctimystes_pterodactyla", #typo in genus
                                   "Hylambates_boulengeri" = "Hylambates_boulengeri",
                                   "Hyperolius_swinnertoni" = "Hyperolius_swynnertoni", #typo in species name
                                   "Crossodactylodes_itambae" = "Crossodactylodes_itambe", #typo in species name
                                   "Heleioporus_psamophilus" = "Heleioporus_psammophilus", #typo in species name
                                   "Platyplectrum_fletcheri" = "Platyplectrum_fletcheri",
                                   "Platyplectrum_melanopyga" = "Platyplecturm_melanopyga",
                                   "Panophrys_tuberogranulata" = "Panophrys_tuberogranulata",
                                   "Cophyla_cowani" = "Cophyla_cowanii",
                                   "Geocrinia_leali" = "Geocrinia_leai", #typo in species name
                                   "Pseudophryne_covacecevichae" = "Pseudophryne_covacevichae", #typo in species name
                                   "Pseudophryne_guntheri" = "Pseudophryne_guentheri", #typo in species name
                                   "Uperoleia_davisae" = "Uperoleia_daviesae", #typo in species name
                                   "Anhydrophryne_ngogoniensis" = "Anhydrophryne_ngongoniensis", #typo in species name
                                   "Lithobates_johnsi" = "Lithobates_johni", #typo in species name
                                   "Papurana_baramica" = "Papurana_baramica", #species does not exit - maybe they meant Pulchrana baramica? Can't be sure so will not change.
                                  "Vampyrius_vampyrus" = "Vampyrius_vampyrus",
                                   "Rhyacotritum_variegatus" = "Rhyacotriton_variegatus" #typo in genus name.
                                   ))


#merge these updated names with original data update
cervino.update2 <- full_join(cervino.update, filledASW)

#remerge with pupil data
cervino.ASW <- left_join(cervino.data, cervino.update2, by = "genus_species") 

# check for duplicates of ASW species
n_occur <- data.frame(table(cervino.ASW$ASW_names))
```

After converting to names current in Frost (2021) taxonomy, we find that 30 species in Cervino et al. (2021) are mapping to duplicate Amphibian Species of the World names. 

Here are the number of species according to Cervino et al (2021):

```{r}
length(levels(as.factor(cervino.data$genus_species)))
```

And the number according to Frost (2021):

```{r}
length(levels(as.factor(cervino.ASW$ASW_names)))
```

These are as follows:

(format: ASW name = Cervino names that match)

**These synonyms show consistent pupil categorizations**

- Bombina microdeladigitora = Bombina fortinuptialis, B. lichuanensis, B. microdeladigitoria 
- Amietia delalandii = Amietia_delalandii,  Amietia_quecketti 
- Amietia_vertebralis = Amietia_umbraculata & Amietia_vertebralis
- Aplastodiscus_albosignatus = Aplastodiscus_albosignatus, Aplastodiscus_callipygius
- Atelopus_flavescens = Atelopus_flavescens & Aplastodiscus_callipygius
- Bufo_gargarizans = Bufo_gargarizans & Bufo_tibetanus
- Bufotes_boulengeri = Bufotes_boulengeri, Bufotes_siculus
- Duttaphrynus_scaber = Duttaphrynus_atukoralei, Duttaphrynus_scaber
- Espadarana_audax = Espadarana_audax, Espadarana_fernandoi
- Gephyromantis_corvus = Gephyromantis_azzurrae, Gephyromantis_corvus
- Indosylvirana_nicobariensis = Amnirana_nicobariensis, Indosylvirana_nicobariensis 
- Leiopelma_hamiltoni = Leiopelma_hamiltoni, Leiopelma_pakeka
- Leptobrachium_ailaonicum = Leptobrachium_ailaonicum, Leptobrachium_echinatum
- Leptopelis_aubryioides = Leptopelis_aubryioides, Leptopelis_omissus
- Leptopelis_flavomaculatus = Leptopelis_barbouri, Leptopelis_flavomaculatus
- Leptopelis_viridis = Leptopelis_hyloides, Leptopelis_viridis
- Melanophryniscus_pachyrhynus = Melanophryniscus_orejasmirandai, Melanophryniscus_pachyrhynus
- Odontophrynus_occidentalis = Odontophrynus_achalensis, Odontophrynus_occidentalis
- Pelophylax_lessonae = Pelophylax_esculentus, Pelophylax_lessonae
- Phrynobatrachus_latifrons = Phrynobatrachus_latifrons, Phrynobatrachus_accraensis
- Pithecopus_oreades = Phyllomedusa_araguari, Phyllomedusa_oreades
- Ranoidea_raniformis = Litoria_raniformis, Ranoidea_raniformis
- Rhacophorus_calcaneus = Rhacophorus_calcaneus, Rhacophorus_chuyangsinensis
- Rhinella_crucifer = Rhinella_crucifer, Rhinella_pombali
- Rulyrana_saxiscandens = Rulyrana_saxiscandens, Rulyrana_tangarana
- Tepuihyla_rodriguezi = Tepuihyla_rodriguezi, Tepuihyla_talbergae
- Uperoleia_rugosa = Uperoleia_capitulata, Uperoleia_rugosa


**These synonyms show different pupil shape categorizations**

- Osteocephalus_buckleyi = Osteocephalus_buckleyi, Osteocephalus_vilmae

*Note: O. buckleyi and O. vilmae are synonyms according to Frost (2021) as of 30 October 2021. It is odd that they have been categorized with different pupil shapes here. Categorizes O. buckleyi as Rhomboidal- subrhomboidal citing Kok & Kalamandeen (2008); categorizes O. vilmae as Horizontal citing https://amphibiaweb.org/species/8036.

- Ranoidea_dayi = Nyctimystes_hosmeri, Ranoidea_dayi

*Note: N. hosmeri is a junior synonym of R. dayi according to Frost (2021) as of 30 October 2021. However, in Cervino et al. N. hosmeri is categorized as having a Vertical pupil (cites Tyler and Davies (1979)) and R. dayi as having a Horizontal pupil (cites Anstis (2013); CalPhotos ID: 0000 0000 0310 0417). 

When we merge datasets, duplicate ASW names will be dropped, which is why I have noted them above. 


# Sampling overlap

## All sampling by study

Here, we merge the three datasets to look at all taxa that have been coded for pupil shape. 

```{r}

#prep data for joining
thomas.join <- thomas.data %>%
  rename(genus_species_Thomas = genus_species,
         constriction_Thomas = Final_Constriction, 
         shape_Thomas = Final_Shape, 
         aquatic_Thomas = aquatic,
         fossorial_Thomas = fossorial, 
         arboreal_Thomas = arboreal, 
         diurnal_Thomas = diurnal) %>%
  select(ASW_names, genus_species_Thomas, Order, Family, constriction_Thomas, shape_Thomas, aquatic_Thomas, fossorial_Thomas, arboreal_Thomas, diurnal_Thomas, pupil_ref_Thomas, pupil_link_Thomas, pupil_link2_Thomas, ecology_ref_Thomas)

cervino.join <- cervino.ASW %>%
  rename(genus_species_Cervino = genus_species,
         shape_Cervino = Pupil_shape,
         habit_Cervino = Adult_habits,
         activity_Cervino = Diel_activity) %>%
  select(ASW_names, Order, Family, genus_species_Cervino, shape_Cervino, habit_Cervino, activity_Cervino, pupil_ref_Cervino, eco_ref_Cervino)

yovanovich.join <- yovanovich.ASW %>%
  rename(genus_species_Yov = genus_species,
         shape_Yov = pupil_shape,
         activity_Yov = act_period) %>%
  select(ASW_names, genus_species_Yov, shape_Yov, activity_Yov, Order, Family)

#join datasets
pupils.join <- full_join(thomas.join, cervino.join, 
                        by = "ASW_names",
                        suffix = c("_Thomas", "_Cervino")) %>%
  #merge taxonomic rankings (choose Thomas et al unless not available, then use Cervino et al)
  mutate(Order = ifelse(is.na(Order_Thomas), Order_Cervino, Order_Thomas)) %>% 
  mutate(Family = ifelse(is.na(Family_Thomas), Family_Cervino, Family_Thomas)) %>%
  select(-Order_Thomas, -Family_Thomas, -Order_Cervino, -Family_Cervino)


#add yovanovich data to 
pupils.all <- full_join(pupils.join, yovanovich.join,
                        by = "ASW_names",
                        suffix = c("","_Yov")) %>%
  #merge taxonomic rankings (only use Yovanovich if not already populated)
  mutate(Order = ifelse(is.na(Order), Order_Yov, Order)) %>% 
  mutate(Family = ifelse(is.na(Family), Family_Yov, Family)) %>%
  mutate(Genus = gsub('_.*', '', ASW_names)) %>%
  select(-Order_Yov, -Family_Yov)
```

After merging all the data, we can examine sampling overlap for pupil shape and for pupil shape + ecology across species. 

## Sampling overlap for pupil shape

```{r}

#subset for shape
shape.compare <- pupils.all %>%
  #add column to show study sampling/overlap
  mutate(sampling = ifelse(!is.na(constriction_Thomas) & is.na(shape_Cervino) & is.na(shape_Yov), "Thomas", NA)) %>%
  mutate(sampling = ifelse(!is.na(constriction_Thomas) & !is.na(shape_Cervino) & is.na(shape_Yov), "Thomas & Cervino", sampling)) %>%
  mutate(sampling = ifelse(!is.na(constriction_Thomas) & !is.na(shape_Cervino) & !is.na(shape_Yov), "Thomas & Cervino & Yovanovich", sampling)) %>%
  mutate(sampling = ifelse(is.na(constriction_Thomas) & !is.na(shape_Cervino) & is.na(shape_Yov), "Cervino", sampling)) %>%
  mutate(sampling = ifelse(is.na(constriction_Thomas) & !is.na(shape_Cervino) & !is.na(shape_Yov), "Cervino & Yovanovich", sampling)) %>%
  mutate(sampling = ifelse(!is.na(constriction_Thomas) & is.na(shape_Cervino) & !is.na(shape_Yov), "Thomas & Yovanovich", sampling)) %>%
  mutate(sampling = ifelse(is.na(constriction_Thomas) & is.na(shape_Cervino) & !is.na(shape_Yov), "Yovanovich", sampling)) %>%
  mutate_if(is.character,as.factor)

#Number of species sampled by each study 
counts <- shape.compare %>%
  mutate_if(is.character,as.factor) %>%
  mutate(sampling = factor(sampling, levels = c("Thomas", "Cervino", "Yovanovich", "Thomas & Cervino", "Thomas & Yovanovich", "Cervino & Yovanovich", "Thomas & Cervino & Yovanovich"))) %>%
  group_by(sampling) %>%
  summarise(n_species = n())
            
#summary of sampling
kable(counts[ , c("sampling", "n_species")], caption = "Sampling overlap of species across studies of amphibian pupil shape") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "500px")
```

To date across these three studies, 3641 amphibian species (according to Frost, 2021) have been coded for pupil shape. 

Next, we pull out the species that we categorized in this study that were also categorized by one or both of the other published studies so that we can compare our findings. 

```{r}
overlap.data <- shape.compare %>%
  filter(sampling == "Thomas & Cervino" | sampling == "Thomas & Yovanovich"| sampling == "Thomas & Cervino & Yovanovich") %>%
    mutate_if(is.character,as.factor)

```

In total, there are `r nrow(overlap.data)` species in our dataset that overlap with other studies. 

Next, we will flag major mismatches between pupil categorizations across these species/studies. This is a bit tricky, as each study used a different approach for pupil categorization. However, there are a few things that should be fairly similar. 

First, we take a look at the levels of categorization from each study:

In this study (Thomas et al.), we coded shape as:

```{r}
levels(shape.compare$shape_Thomas)
```

And orientation as: 

```{r}
levels(shape.compare$constriction_Thomas)
```

Cervino et al. coded shape as:

```{r}
levels(shape.compare$shape_Cervino)
```

Yovanovich et al. coded shape as: 

```{r}
levels(shape.compare$shape_Yov)
```

From the descriptions of classification from each paper, we know that:

1) Species that Yovanovich coded as "round" should match species that we coded as "circle" for shape and "symmetrical" for orientation 

2) Species that Yovanovich coded as "elongate" should match species that we coded as "vertical" or "horizontal" for orientation

3) Species that Cervino coded as "Circular" should match species that we coded as "circle" for shape and "symmetrical" for orientation 

4) Species that Cervino coded as "Horizontal" should match species that we coded as "horizontal" for orientation (only in this direction; some things we coded as horizontal would match other Cervino shapes but all that Cervino codes as horizontal should match to us coding as horizontal)

5) Species that Cervino coded as "Vertical" should match species that we coded as "vertical" for orientation (only in this direction; some things we coded as vertical would match other Cervino shapes but all that Cervino codes as vertical should match to us coding as vertical)

Other shapes coded by Cervino don't have a direct translation to our shapes (except perhaps "triangular" and our "triangle", but since we don't quantitatively address shape in our paper I am focusing on the important functional aspect that we do analyze, which is the orientation of a constricted pupil).

Below, I take each of these expectations and create a new column in the dataframe with notes on whether the studies agree on categorization or disagree, and how. This should help us to go through mismatches and get a sense of what is going on, and to quantify the extent to which the studies replicate pupil categorization or disagree. 

```{r}

overlap.comments <- overlap.data %>%
# 1) Species that Yovanovich coded as "round" should match species that we coded as "circle" for shape and "symmetrical" for orientation 
  mutate(Yov_compare = ifelse(shape_Thomas=="circle" & shape_Yov=="round", "T & Y agree on circular pupil", NA)) %>%
  mutate(Yov_compare = ifelse(shape_Thomas=="circle" & shape_Yov!="round" & !is.na(shape_Yov), "T & Y disagree on circular pupil", Yov_compare)) %>%
  mutate(Yov_compare = ifelse(shape_Thomas!="circle" & shape_Yov=="round" & !is.na(shape_Thomas), "T & Y disagree - Yov says circular Thom says elongated", Yov_compare)) %>%
# 2) Species that Yovanovich coded as "elongate" should match species that we coded as "vertical" or "horizontal" for orientation
  mutate(Yov_compare = ifelse((constriction_Thomas=="horizontal" | constriction_Thomas=="vertical") & shape_Yov=="elongate", "T & Y agree on elongated pupil", Yov_compare)) %>%
# 3) Species that Cervino coded as "Circular" should match species that we coded as "circle" for shape and "symmetrical" for orientation 
  mutate(Cerv_compare = ifelse(shape_Thomas=="circle" & shape_Cervino=="Circular", "T & C agree on circular pupil", NA)) %>%
  mutate(Cerv_compare = ifelse(shape_Thomas=="circle" & shape_Cervino!="Circular" & !is.na(shape_Cervino), "T & C disagree - T says circular C says not", Cerv_compare)) %>%
  mutate(Cerv_compare = ifelse(shape_Thomas!="circle" & shape_Cervino=="Circular" & !is.na(shape_Thomas), "T & C disagree - C says circular T says not", Cerv_compare)) %>%
# 4) Species that Cervino coded as "Horizontal" should match species that we coded as "horizontal" for orientation (only in this direction; some things we coded as horizontal would match other Cervino shapes but all that Cervino codes as horizontal should match to us coding as horizontal)
  mutate(Cerv_compare = ifelse(constriction_Thomas=="horizontal" & shape_Cervino=="Horizontal", "T & C agree on horizontal pupil", Cerv_compare)) %>%
  mutate(Cerv_compare = ifelse(constriction_Thomas!="horizontal" & shape_Cervino=="Horizontal" & !is.na(constriction_Thomas), "T & C disagree - C says horizontal T says not", Cerv_compare)) %>%
# 5) Species that Cervino coded as "Vertical" should match species that we coded as "vertical" for orientation (only in this direction; some things we coded as vertical would match other Cervino shapes but all that Cervino codes as vertical should match to us coding as vertical)
 mutate(Cerv_compare = ifelse(constriction_Thomas=="vertical" & shape_Cervino=="Vertical", "T & C agree on vertical pupil", Cerv_compare)) %>%
  mutate(Cerv_compare = ifelse(constriction_Thomas!="vertical" & shape_Cervino=="Vertical" & !is.na(constriction_Thomas), "T & C disagree - C says vertical T says not", Cerv_compare))

overlap.comments.tidy <- overlap.comments %>% select(ASW_names, Yov_compare, Cerv_compare, shape_Thomas, constriction_Thomas, pupil_ref_Thomas, pupil_link_Thomas, pupil_link2_Thomas, shape_Cervino, pupil_ref_Cervino, shape_Yov, Order, Family, Genus)

#export all data
write.csv(overlap.comments.tidy, file = "../study_comparison.csv")
```

We can export this file for closer inspection, and look at a quick summary of how pupil categorization compared across studies:

```{r}
#Summary of overlap with Yovanovich
counts_y <- overlap.comments %>%
  mutate_if(is.character,as.factor) %>%
  group_by(Yov_compare) %>%
  summarise(n_species = n())

#Summary of overlap with Cervino
counts_c <- overlap.comments %>%
  mutate_if(is.character,as.factor) %>%
  group_by(Cerv_compare) %>%
  summarise(n_species = n())
            
#summary of sampling
kable(counts_y[ , c("Yov_compare", "n_species")], caption = "Comparison of pupil categorization in this study vs. Yovanovich et al. 2020") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "500px")

#summary of sampling
kable(counts_c[ , c("Cerv_compare", "n_species")], caption = "Comparison of pupil categorization in this study vs. Cervino et al. 2021") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "500px")
```

We can also export a file that only includes data that doesn't match across studies, so that we can examine those data more closely. 

```{r}
mismatch.data <- overlap.comments.tidy %>%
  filter(
    Yov_compare=="T & Y disagree - Yov says circular Thom says elongated" | 
    Cerv_compare=="T & C disagree - C says horizontal T says not" | 
    Cerv_compare=="T & C disagree - C says vertical T says not" | 
    Cerv_compare=="T & C disagree - T says circular C says not")

#export mismatched data
write.csv(mismatch.data, file = "../mismatched_data.csv")
```



## Sampling overlap for pupil shape + ecology

Here we first can take a look at the species across all studies that have been coded for ecology in some way and examine how they are distributed across studies. 

```{r}

#subset for ecology
eco.compare <- pupils.all %>%
  #filter to include only species with ecological data
  filter(!if_all(c(aquatic_Thomas, fossorial_Thomas, arboreal_Thomas, diurnal_Thomas, habit_Cervino, activity_Cervino, activity_Yov), is.na)) %>%
  #add column to show study ecology sampling/overlap
  #just thomas sampled
  mutate(eco_sampling = ifelse(!if_all(c(aquatic_Thomas, fossorial_Thomas, arboreal_Thomas, diurnal_Thomas), is.na) & if_all(c(habit_Cervino, activity_Cervino), is.na) & is.na(activity_Yov), "Thomas", NA)) %>%
    #just cervino sampled
   mutate(eco_sampling = ifelse(if_all(c(aquatic_Thomas, fossorial_Thomas, arboreal_Thomas, diurnal_Thomas), is.na) & !if_all(c(habit_Cervino, activity_Cervino), is.na) & is.na(activity_Yov), "Cervino", eco_sampling)) %>%
  #just yovanovich sampled
  mutate(eco_sampling = ifelse(if_all(c(aquatic_Thomas, fossorial_Thomas, arboreal_Thomas, diurnal_Thomas), is.na) & if_all(c(habit_Cervino, activity_Cervino), is.na) & !is.na(activity_Yov), "Yovanovich", eco_sampling)) %>%
  #thomas + cervino sampled
  mutate(eco_sampling = ifelse(!if_all(c(aquatic_Thomas, fossorial_Thomas, arboreal_Thomas, diurnal_Thomas), is.na) & !if_all(c(habit_Cervino, activity_Cervino), is.na) & is.na(activity_Yov), "Thomas & Cervino", eco_sampling)) %>%
  #thomas + yovanovich sampled
  mutate(eco_sampling = ifelse(!if_all(c(aquatic_Thomas, fossorial_Thomas, arboreal_Thomas, diurnal_Thomas), is.na) & if_all(c(habit_Cervino, activity_Cervino), is.na) & !is.na(activity_Yov), "Thomas & Yovanovich", eco_sampling)) %>%
    #cervino + yovanovich sampled
  mutate(eco_sampling = ifelse(if_all(c(aquatic_Thomas, fossorial_Thomas, arboreal_Thomas, diurnal_Thomas), is.na) & !if_all(c(habit_Cervino, activity_Cervino), is.na) & !is.na(activity_Yov), "Cervino & Yovanovich", eco_sampling)) %>%
  #thomas + cervino + yovanovich sampled
 mutate(eco_sampling = ifelse(!if_all(c(aquatic_Thomas, fossorial_Thomas, arboreal_Thomas, diurnal_Thomas), is.na) & !if_all(c(habit_Cervino, activity_Cervino), is.na) & !is.na(activity_Yov), "Thomas & Cervino & Yovanovich", eco_sampling)) %>%
  mutate_if(is.character,as.factor)

#Number of species sampled by each study 
counts.eco <- eco.compare %>%
  mutate(eco_sampling = factor(eco_sampling, levels = c("Thomas", "Cervino", "Yovanovich", "Thomas & Cervino", "Thomas & Yovanovich", "Cervino & Yovanovich", "Thomas & Cervino & Yovanovich"))) %>%
  group_by(eco_sampling) %>%
  summarise(n_species = n())
            
#summary of sampling
kable(counts.eco[ , c("eco_sampling", "n_species")], caption = "Sampling overlap of species coded for ecology across studies of amphibian pupil shape") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "500px")


```

Next, we find the subset of species that we coded for ecology that also overlap in sampling with one/both of the other studies so that we can compare ecological trait categorizations. 

```{r}
#subset to species with overlap across studies
overlap.eco <- eco.compare %>%
  filter(eco_sampling == "Thomas & Cervino" | eco_sampling == "Thomas & Yovanovich"| eco_sampling == "Thomas & Cervino & Yovanovich") %>%
    mutate_if(is.character,as.factor)
```

In total, there are `r nrow(overlap.eco)` species in our ecology + pupil dataset that overlap with other studies. 

Next, we will flag major mismatches between ecological categorizations across these species/studies. Again this is a bit tricky, as each study used a different approach for ecological categorization. 

First, we take a look at the levels of categorization from each study:

Our study (Thomas et al.) coded ecological traits into binary states (yes/no) for: aquatic, fossorial, arboreal, diurnal. 

```{r}
levels(eco.compare$aquatic_Thomas)
levels(eco.compare$fossorial_Thomas)
levels(eco.compare$arboreal_Thomas)
levels(eco.compare$diurnal_Thomas)
```

Yovanovich et al. categorized activity period into binary states:

```{r}
levels(eco.compare$activity_Yov)
```

Cervino et al. categorized adult habit as:

```{r}
levels(eco.compare$activity_Cervino)
```

and adult activity period as: 

```{r}
levels(eco.compare$habit_Cervino)
```


From the descriptions of classification from each paper, we know that:

1) Species that Yovanovich coded as "diurnal" should match species that we coded as "yes" for diurnal & species Yovanovich coded as "nocturnal" should match species that we coded as "no" for diurnal.

2) Species that Cervino coded as "Diurnal" should match species that we coded as "yes" for diurnal & species that Cervino coded as "Arrhythmic" or "Nocturnal" should match species that we coded as "no" for diurnal.

3) Species that Cervino coded as "Aquatic" should match species that we coded as "yes" for aquatic. 

4) Species that Cervino coded as "Scansorial" should (perhaps) match species that we coded as "yes" for arboreal. Note that the criteria for categorization differ a bit and could results in differences, but still useful to have a look at this. 

5) Species that Cervino coded as "Fossorial" may (definitions differ slightly) match species that we coded as "yes" for fossorial. Note that the criteria for categorization differ (In Cervino fossorial includes subfossorial/leaf litter species) and could results in differences, but still useful to have a look at this. 

Below, I take each of these expectations and create a new column in the dataframe with notes on whether the studies agree on categorization or disagree, and how. This should help us to go through mismatches and get a sense of what is going on, and to quantify the extent to which the studies ecological assignments. 

```{r}

eco.overlap.comments <- overlap.eco %>%
  # 1) Species that Yovanovich coded as "diurnal" should match species that we coded as "yes" for diurnal & species Yovanovich coded as "nocturnal" should match species that we coded as "no" for diurnal.
  mutate(Yov_comp_diur = ifelse(diurnal_Thomas=="yes" & activity_Yov=="diurnal", "T & Y agree on diurnal activity", NA)) %>%
  mutate(Yov_comp_diur = ifelse(diurnal_Thomas=="no" & activity_Yov=="diurnal", "T & Y disagree - Y says diurnal and T says not", Yov_comp_diur)) %>%
  mutate(Yov_comp_diur = ifelse(diurnal_Thomas=="yes" & activity_Yov=="nocturnal", "T & Y disagree - T says diurnal and Y says not", Yov_comp_diur)) %>%
  mutate(Yov_comp_diur = ifelse(diurnal_Thomas=="no" & activity_Yov=="nocturnal", "T & Y agree on non-diurnal activity", Yov_comp_diur)) %>%
# 2) Species that Cervino coded as "Diurnal" should match species that we coded as "yes" for diurnal & species that Cervino coded as "Arrhythmic" or "Nocturnal" should match species that we coded as "no" for diurnal.
  mutate(Cerv_comp_diur = ifelse(diurnal_Thomas=="yes" & activity_Cervino=="Diurnal", "T & C agree on diurnal activity", NA)) %>%
  mutate(Cerv_comp_diur = ifelse(diurnal_Thomas=="yes" & activity_Cervino!="Diurnal" & !is.na(activity_Cervino), "T & C disagree - T says diurnal and C says not", Cerv_comp_diur)) %>%
  mutate(Cerv_comp_diur = ifelse(diurnal_Thomas=="no" & activity_Cervino=="Diurnal", "T & C disagree - C says diurnal and T says not", Cerv_comp_diur)) %>%
  mutate(Cerv_comp_diur = ifelse(diurnal_Thomas=="no" & activity_Cervino!="Diurnal" & !is.na(activity_Cervino), "T & C agree on non-diurnal activity", Cerv_comp_diur)) %>%
# 3) Species that Cervino coded as "Aquatic" should match species that we coded as "yes" for aquatic. 
   mutate(Cerv_comp_aq = ifelse(aquatic_Thomas =="yes" & habit_Cervino=="Aquatic", "T & C agree on aquatic", NA)) %>%
  mutate(Cerv_comp_aq = ifelse(aquatic_Thomas =="yes" & habit_Cervino!="Aquatic" & !is.na(habit_Cervino), "T & C disagree - T says aquati, C not", Cerv_comp_aq)) %>%
  mutate(Cerv_comp_aq = ifelse(aquatic_Thomas =="no" & habit_Cervino!="Aquatic" & !is.na(habit_Cervino), "T & C agree on non-aquatic", Cerv_comp_aq)) %>%
  mutate(Cerv_comp_aq = ifelse(aquatic_Thomas == "no" & habit_Cervino =="Aquatic", "T & C disagree - C says aquatic, T not", Cerv_comp_aq)) %>%
# 4) Species that Cervino coded as "Scansorial" should (perhaps) match species that we coded as "yes" for arboreal. Note that the criteria for categorization differ a bit and could results in differences, but still useful to have a look at this. 
  mutate(Cerv_comp_arb = ifelse(arboreal_Thomas =="yes" & habit_Cervino=="Scansorial", "T & C agree on scansorial/arboreal", NA)) %>%
  mutate(Cerv_comp_arb = ifelse(arboreal_Thomas =="yes" & habit_Cervino!="Scansorial" & !is.na(habit_Cervino), "T & C disagree - T says arboreal, C not", Cerv_comp_arb)) %>%
  mutate(Cerv_comp_arb = ifelse(arboreal_Thomas =="no" & habit_Cervino!="Scansorial" & !is.na(habit_Cervino), "T & C agree on non-arboreal", Cerv_comp_arb)) %>%
  mutate(Cerv_comp_arb = ifelse(arboreal_Thomas == "no" & habit_Cervino =="Scansorial", "T & C disagree - C says scanosrial, T not", Cerv_comp_arb)) %>%
# 5) Species that Cervino coded as "Fossorial" may (definitions differ slightly) match species that we coded as "yes" for fossorial. Note that the criteria for categorization differ (In Cervino fossorial includes subfossorial/leaf litter species) and could results in differences, but still useful to have a look at this.
 mutate(Cerv_comp_foss = ifelse(fossorial_Thomas =="yes" & habit_Cervino=="Fossorial", "T & C agree on fossorial", NA)) %>%
  mutate(Cerv_comp_foss = ifelse(fossorial_Thomas =="yes" & habit_Cervino!="Fossorial" & !is.na(habit_Cervino), "T & C disagree - T says fossorial, C not", Cerv_comp_foss)) %>%
  mutate(Cerv_comp_foss = ifelse(fossorial_Thomas =="no" & habit_Cervino!="Fossorial" & !is.na(habit_Cervino), "T & C agree on non-fossorial", Cerv_comp_foss)) %>%
  mutate(Cerv_comp_foss = ifelse(fossorial_Thomas == "no" & habit_Cervino =="Fossorial", "T & C disagree - C says fossorial, T not", Cerv_comp_foss))
  
#export
write.csv(eco.overlap.comments, file = "../ecology_comparison.csv")
```

We can export this file for closer inspection, and look at a quick summary of how ecological categorization compared across studies:

```{r}
#Summary of overlap for activity period with Yovanovich
counts_yact <- eco.overlap.comments %>%
  mutate_if(is.character,as.factor) %>%
  group_by(Yov_comp_diur) %>%
  summarise(n_species = n())

kable(counts_yact[ , c("Yov_comp_diur", "n_species")], caption = "Comparison of activity period categorization in this study vs. Yovanovich et al. 2020") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "500px")

#Summary of overlap for activity period with Cervino
counts_cact <- eco.overlap.comments %>%
  mutate_if(is.character,as.factor) %>%
  group_by(Cerv_comp_diur) %>%
  summarise(n_species = n())

kable(counts_cact[ , c("Cerv_comp_diur", "n_species")], caption = "Comparison of activity period categorization in this study vs. Cervino et al. 2021") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "500px")

#Summary of overlap for aquatic with Cervino
counts_aq <- eco.overlap.comments %>%
  mutate_if(is.character,as.factor) %>%
  group_by(Cerv_comp_aq) %>%
  summarise(n_species = n())

kable(counts_aq[ , c("Cerv_comp_aq", "n_species")], caption = "Comparison of designation of aquatic species in this study vs. Cervino et al. 2021") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "500px")


#Summary of overlap for scansorial with Cervino
counts_arb <- eco.overlap.comments %>%
  mutate_if(is.character,as.factor) %>%
  group_by(Cerv_comp_arb) %>%
  summarise(n_species = n())

kable(counts_arb[ , c("Cerv_comp_arb", "n_species")], caption = "Comparison of designation of arboreal/scansorial species in this study vs. Cervino et al. 2021. Note that system of classification was slightly different.") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "500px")

#Summary of overlap for fossorial with Cervino
counts_foss <- eco.overlap.comments %>%
  mutate_if(is.character,as.factor) %>%
  group_by(Cerv_comp_foss) %>%
  summarise(n_species = n())

kable(counts_foss[ , c("Cerv_comp_foss", "n_species")], caption = "Comparison of designation of fossorial species in this study vs. Cervino et al. 2021. Note that system of classification was slightly different.") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "500px")
            
```

We can also export a file that only includes species with ecological data that doesn't match across studies, so that we can examine those data more closely. 

```{r}
eco.mismatch.data <- eco.overlap.comments %>%
  filter(
    Yov_comp_diur=="T & Y disagree - T says diurnal and Y says not" | 
    Cerv_comp_diur=="T & C disagree - T says diurnal and C says not" | 
    Cerv_comp_aq=="T & C disagree - C says aquatic, T not" | 
    Cerv_comp_aq=="T & C disagree - T says aquati, C not" | 
    Cerv_comp_arb=="T & C disagree - C says scanosrial, T not" | 
    Cerv_comp_foss=="T & C disagree - C says fossorial, T not"| 
    Cerv_comp_foss=="T & C disagree - T says fossorial, C not")

#export mismatched data
write.csv(eco.mismatch.data, file = "../mismatched_data_ecology.csv")
```

